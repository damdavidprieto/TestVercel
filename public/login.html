<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Login - Gestor Documental Peña</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
</head>
<body class="bg-light">

  <div class="container d-flex justify-content-center align-items-center vh-100">
    <div class="card shadow-sm p-4" style="max-width: 400px; width: 100%;">
      <h2 class="card-title mb-4 text-center">Iniciar sesión</h2>
      <button id="googleLoginBtn" class="btn btn-danger w-100">
        Entrar con Google
      </button>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBh6tdi3NswyHj4RVNfIEGYIP9CoMe-BsQ",
    authDomain: "sepultururosvercelapp.firebaseapp.com",
    projectId: "sepultururosvercelapp",
    storageBucket: "sepultururosvercelapp.appspot.com",
    messagingSenderId: "4986417399",
    appId: "1:4986417399:web:537bc902d6037dbc9d23f2",
    measurementId: "G-BYSTFYZPBJ"
  };

  // Inicializar Firebase
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();

  // Asegurar persistencia local (muy importante)
  auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
    .then(() => {
      const provider = new firebase.auth.GoogleAuthProvider();
      provider.setCustomParameters({ prompt: 'select_account' });

      // Botón de login con Google
      document.getElementById('googleLoginBtn').addEventListener('click', () => {
        auth.signInWithPopup(provider)
          .then(async (result) => {
            const token = await result.user.getIdToken();
            localStorage.setItem('firebaseToken', token);
            window.location.href = '/app';
          })
          .catch((error) => {
            console.error("Error en login con popup:", error);
            alert("Error al iniciar sesión: " + error.message);
          });
      });

      // Restaurar sesión si ya estaba logueado
      auth.onAuthStateChanged(async (user) => {
        if (user) {
          console.log("Usuario detectado en login:", user.email);

          // Puedes validar contra el backend si lo deseas:
          /*
          try {
            const token = await user.getIdToken();
            const res = await fetch('/api/validate', {
              headers: { Authorization: `Bearer ${token}` }
            });
            if (res.ok) {
              window.location.href = '/app';
            } else {
              await auth.signOut();
            }
          } catch (err) {
            console.error('Error al validar token:', err);
          }
          */

          // Redirige directamente si no estás validando backend:
          setTimeout(() => {
            window.location.href = '/app';
          }, 200); // pequeño retardo opcional

        } else {
          console.log("Ningún usuario logueado");
        }
      });
    })
    .catch((err) => {
      console.error("Error estableciendo persistencia:", err);
    });
</script>

  const firebaseConfig = {
    apiKey: "AIzaSyBh6tdi3NswyHj4RVNfIEGYIP9CoMe-BsQ",
    authDomain: "sepultururosvercelapp.firebaseapp.com",
    projectId: "sepultururosvercelapp",
    storageBucket: "sepultururosvercelapp.appspot.com",
    messagingSenderId: "4986417399",
    appId: "1:4986417399:web:537bc902d6037dbc9d23f2",
    measurementId: "G-BYSTFYZPBJ"
  };

  // Inicializar Firebase
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();

  const provider = new firebase.auth.GoogleAuthProvider();
  provider.setCustomParameters({
    prompt: 'select_account'
  });

  // Botón de login con Google
  document.getElementById('googleLoginBtn').addEventListener('click', () => {
    auth.signInWithPopup(provider)
      .then(async (result) => {
        const token = await result.user.getIdToken();
        localStorage.setItem('firebaseToken', token);
        window.location.href = '/app';
      })
      .catch((error) => {
        console.error("Error en login con popup:", error);
        alert("Error al iniciar sesión: " + error.message);
      });
  });

  // Verifica el token con el backend antes de redirigir automáticamente
  auth.onAuthStateChanged(async (user) => {
    if (user) {
      try {
        const token = await user.getIdToken();
        localStorage.setItem('firebaseToken', token);

        const res = await fetch('/api/validate', {
          headers: {
            Authorization: `Bearer ${token}`
          }
        });

        if (res.ok) {
          console.log('Token válido, redirigiendo a /app');
          window.location.href = '/app';
        } else {
          console.warn('Token rechazado por backend');
          // Puedes cerrar sesión si el backend lo rechaza
          await auth.signOut();
        }
      } catch (err) {
        console.error('Error validando token con backend:', err);
      }
    }
  });
</script>

</body>
</html>
